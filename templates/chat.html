<!DOCTYPE html>
<html>
<head>
    <title>RealtyBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container { max-height: 360px; overflow-y: auto; border: 1px solid #ccc; padding: 13.5px; border-radius: 9px; } /* 90% of 400px, 15px, 10px */
        .message { margin-bottom: 13.5px; padding: 9px; border-radius: 7.2px; } /* 90% of 15px, 10px, 8px */
        .user-message { background-color: #e6f3ff; text-align: right; }
        .bot-message { background-color: #f8f9fa; text-align: left; }
        .typing-indicator { display: none; color: #888; font-style: italic; }
        .form-container { margin-top: 13.5px; } /* 90% of 15px */
        .upload-container { margin-bottom: 18px; } /* 90% of 20px */
        .sidebar { border-left: 1px solid #ccc; padding: 9px; } /* 90% of 10px */
        .slider-value { font-size: 0.72em; margin-left: 5.4px; } /* 90% of 0.8em, 6px */
        .form-range {
            width: 100%;
            height: 5.4px; /* 90% of 6px */
            padding: 0;
            background: linear-gradient(to right, #007bff 0%, #007bff 100%);
            border-radius: 4.5px; /* 90% of 5px */
        }
        .form-range::-webkit-slider-thumb {
            width: 10.8px; /* 90% of 12px */
            height: 10.8px;
            margin-top: -2.7px; /* 90% of -3px */
            background: #007bff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .form-range::-moz-range-thumb {
            width: 10.8px;
            height: 10.8px;
            background: #007bff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .form-label { font-size: 0.765em; margin-bottom: 2.7px; } /* 90% of 0.85em, 3px */
        .mb-3 { margin-bottom: 7.2px !important; } /* 90% of 8px */
        .sidebar form { max-width: 180px; } /* 90% of 200px */
        .step-section { margin-bottom: 27px; padding: 13.5px; border: 1px solid #ddd; border-radius: 9px; } /* 90% of 30px, 15px, 10px */
        .step-title { font-size: 1.08em; font-weight: bold; margin-bottom: 9px; } /* 90% of 1.2em, 10px */
        .btn { font-size: 0.9em; padding: 5.4px 10.8px; } /* 90% of 1em, 6px, 12px */
    </style>
    <script>
        // Auto-scroll to the latest message
        document.addEventListener('DOMContentLoaded', () => {
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add Enter key submission for chat textarea
            const chatTextarea = document.querySelector('#chat-message');
            chatTextarea.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    submitChatForm(event);
                }
            });
        });

        async function submitChatForm(event) {
            event.preventDefault();
            const form = event.target.closest('form');
            const message = form.querySelector('textarea').value.trim();
            if (!message) return; // Prevent empty submissions
            const typingIndicator = document.querySelector('.typing-indicator');
            typingIndicator.style.display = 'block';
            const response = await fetch('/chat', {
                method: 'POST',
                body: new FormData(form)
            });
            typingIndicator.style.display = 'none';
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to send message. Please try again.');
            }
        }

        async function submitUploadForm(event) {
            event.preventDefault();
            const form = event.target;
            const typingIndicator = document.querySelector('.typing-indicator');
            typingIndicator.style.display = 'block';
            const response = await fetch('/upload', {
                method: 'POST',
                body: new FormData(form)
            });
            typingIndicator.style.display = 'none';
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to upload file. Please try again.');
            }
        }

        async function submitAssumptionsForm(event) {
            event.preventDefault();
            const form = event.target;
            const typingIndicator = document.querySelector('.typing-indicator');
            typingIndicator.style.display = 'block';
            const formData = new FormData(form);
            const response = await fetch('/update_assumptions', {
                method: 'POST',
                body: formData
            });
            typingIndicator.style.display = 'none';
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to update assumptions. Please try again.');
            }
        }

        async function submitReportForm(event) {
            event.preventDefault();
            const typingIndicator = document.querySelector('.typing-indicator');
            typingIndicator.style.display = 'block';
            const response = await fetch('/run_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            typingIndicator.style.display = 'none';
            const result = await response.json();
            if (result.success) {
                window.open(result.url, '_blank'); // Open report in new tab
                window.location.reload(); // Refresh chat to show success message
            } else {
                alert(result.message);
            }
        }

        // Update slider value display in real-time
        function updateSliderValue(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(valueId);
            valueSpan.textContent = `${parseFloat(slider.value).toFixed(2)}%`;
        }
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <div class="col-md-8">
                <h1 class="mt-3.6">RealtyBot: Commercial Real Estate Analysis</h1> <!-- 90% of 4 -->

                <!-- Step 1: Upload Deal Data -->
                <div class="step-section">
                    <div class="step-title">Step 1: Upload Deal Data</div>
                    <p>Upload a CSV file with property data (e.g., template.csv) to start your analysis.</p>
                    <div class="upload-container">
                        <form onsubmit="submitUploadForm(event)" method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="file" class="form-label">Select CSV File:</label>
                                <input type="file" class="form-control" id="file" name="file" accept=".csv">
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                    </div>
                </div>

                <!-- Step 3: Chat with RealtyBot -->
                <div class="step-section">
                    <div class="step-title">Step 3: Chat with RealtyBot</div>
                    <p>Ask questions or change criteria (e.g., 'min_cap_rate: 7%' or 'set min cap rate to 7 percent'). When ready, click 'Run Report' in Step 4.</p>
                    <div class="chat-container">
                        {% for msg in conversation if msg.role != 'system' %}
                        <div class="message {{ 'user-message' if msg.role == 'user' else 'bot-message' }}">
                            <strong>{{ msg.role.capitalize() }}:</strong> {{ msg.content | replace('\n', '<br>') | safe }}
                        </div>
                        {% endfor %}
                        <div class="typing-indicator">Typing...</div>
                    </div>
                    <div class="form-container">
                        <form onsubmit="submitChatForm(event)" method="post">
                            <div class="mb-3">
                                <textarea class="form-control" id="chat-message" name="message" rows="3" placeholder="Type your message (e.g., 'min_cap_rate: 7%' or 'set min cap rate to 7 percent')..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send</button>
                            <a href="/reset" class="btn btn-secondary">Start Over</a>
                        </form>
                    </div>
                </div>

                <!-- Step 4: Run Report -->
                <div class="step-section">
                    <div class="step-title">Step 4: Run Report</div>
                    <p>Click below to generate and view the analysis report in a new tab.</p>
                    <form onsubmit="submitReportForm(event)" method="post">
                        <button type="submit" class="btn btn-success">Run Report</button>
                    </form>
                </div>
            </div>

            <!-- Step 2: Review and Change Assumptions -->
            <div class="col-md-4">
                <div class="step-section sidebar">
                    <div class="step-title">Step 2: Review and Change Assumptions</div>
                    <p>Adjust the analysis criteria using the sliders below, then click Update Assumptions.</p>
                    <form onsubmit="submitAssumptionsForm(event)" method="post">
                        {% for key, value in assumptions.items() %}
                        {% if key in ["min_cap_rate", "max_cap_rate", "min_cash_on_cash", "min_occupancy", "min_noi_growth", "max_noi_growth", "min_appreciation", "max_appreciation", "min_irr", "default_tax_rate"] %}
                        <div class="mb-3">
                            <label for="{{ key }}" class="form-label">{{ key.replace('_', ' ') }}: <span class="slider-value" id="{{ key }}_value">{{ value * 100 | float | round(2) }}%</span></label>
                            <input type="range" class="form-range" id="{{ key }}" name="{{ key }}" min="0" max="10" step="0.01" value="{{ value * 100 | float | round(2) }}" oninput="updateSliderValue('{{ key }}', '{{ key }}_value')">
                        </div>
                        {% else %}
                        <div class="mb-3">
                            <label for="{{ key }}" class="form-label">{{ key.replace('_', ' ') }}</label>
                            <input type="number" class="form-control" id="{{ key }}" name="{{ key }}" value="{{ value }}" step="0.1">
                        </div>
                        {% endif %}
                        {% endfor %}
                        <button type="submit" class="btn btn-primary btn-sm">Update Assumptions</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>