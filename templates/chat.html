<!-- templates/chat.html -->
<!-- Main UI for RealtyBot: chat, assumptions sliders, file upload, and property search/selection. -->
<!DOCTYPE html>
<html>
<head>
    <title>RealtyBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-size: 0.9rem; } /* 90% of 1rem */
        .container { max-width: 90%; margin-top: 18px; } /* 90% of 100%, 20px */
        .sidebar { width: 180px; position: fixed; right: 18px; top: 18px; } /* 90% of 200px */
        .chat-container { max-height: 540px; overflow-y: auto; margin-bottom: 18px; } /* 90% of 600px */
        .form-control, .btn { font-size: 0.9rem; } /* 90% of 1rem */
        .slider { height: 5.4px; } /* 90% of 6px */
        .table { font-size: 0.9rem; } /* 90% of 1rem */
        .step { margin-bottom: 18px; } /* 90% of 20px */
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <!-- Step 1: File Upload -->
                <div class="step">
                    <h3>Step 1: Upload Data or Search Properties</h3>
                    <form action="/upload" method="post" enctype="multipart/form-data">
                        <input type="file" name="file" accept=".csv" class="form-control">
                        <button type="submit" class="btn btn-primary mt-2">Upload CSV</button>
                    </form>
                </div>

                <!-- Step 3: Chat Interface -->
                <div class="step">
                    <h3>Step 3: Chat with RealtyBot</h3>
                    <div class="chat-container card p-3">
                        {% for msg in conversation %}
                            <div class="mb-2">
                                <strong>{{ 'You' if msg.role == 'user' else 'RealtyBot' }}:</strong>
                                <p>{{ msg.content | replace('\n', '<br>') | safe }}</p>
                            </div>
                        {% endfor %}
                    </div>
                    <form action="/chat" method="post">
                        <textarea name="message" class="form-control" rows="4" placeholder="Type here (e.g., 'search properties office Orlando min price 1M' or 'min_cap_rate: 7%')"></textarea>
                        <button type="submit" class="btn btn-primary mt-2">Send</button>
                    </form>
                </div>

                <!-- Search Results Table -->
                {% if search_results %}
                <div class="step">
                    <h3>Property Search Results</h3>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Sq Ft</th>
                                <th>Select</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i, prop in enumerate(search_results) %}
                            <tr>
                                <td>{{ i + 1 }}</td>
                                <td>{{ prop.type }}</td>
                                <td>{{ prop.location }}</td>
                                <td>${{ prop.purchase_price | float | round(0) | int | format_number }}</td>
                                <td>{{ prop.sq_ft }}</td>
                                <td><button class="btn btn-sm btn-outline-primary" onclick="selectProperty('{{ i + 1 }}')">Select</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <!-- Step 4: Run Report -->
                <div class="step">
                    <h3>Step 4: Generate Report</h3>
                    <button class="btn btn-success" onclick="runReport()">Run Report</button>
                </div>
            </div>

            <!-- Step 2: Assumptions Sidebar -->
            <div class="col-md-4 sidebar">
                <h3>Step 2: Assumptions</h3>
                <form action="/update_assumptions" method="post">
                    {% for key, value in assumptions.items() %}
                    <div class="mb-3">
                        <label>{{ key.replace('_', ' ') }}</label>
                        <input type="range" name="{{ key }}" min="{{ '0' if 'rate' in key else '0' }}" max="{{ '20' if 'rate' in key else '100' }}" step="{{ '0.1' if 'rate' in key else '1' }}"
                               value="{{ value * 100 if 'rate' in key else value }}" class="form-range slider"
                               oninput="this.nextElementSibling.value = this.value">
                        <output>{{ value * 100 if 'rate' in key else value }}</output>
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary">Update Assumptions</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Auto-scroll chat to bottom
        const chatContainer = document.querySelector('.chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Select property and send to chat
        function selectProperty(id) {
            const textarea = document.querySelector('textarea[name="message"]');
            textarea.value = `select ${id}`;
            document.querySelector('form[action="/chat"]').submit();
        }

        // Run report via AJAX to open in new tab
        function runReport() {
            fetch('/run_report', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.open(data.url, '_blank');
                    } else {
                        alert(data.message);
                    }
                });
        }

        // Format numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>
</body>
</html>